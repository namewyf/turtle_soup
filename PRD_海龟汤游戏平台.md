# 海龟汤游戏平台 - 产品需求文档 (PRD)

## 1. 产品概述

### 1.1 产品介绍
海龟汤游戏平台是一个基于AI主持人的多人在线推理游戏平台。玩家通过提问来推理出不完整故事的完整答案，AI主持人根据海龟汤游戏规则进行智能回答。

### 1.2 目标用户
- **主要用户**：喜欢推理游戏的用户群体
- **次要用户**：教育机构、团队建设活动组织者
- **管理员**：平台运营管理人员

### 1.3 核心价值
- 提供AI驱动的智能游戏主持服务
- 支持多人实时协作推理
- 丰富的故事库和用户贡献机制
- 便捷的房间管理和用户交互体验

## 2. 用户角色定义

### 2.1 房主 (Room Owner)
- **权限**：创建房间、上传故事、切换故事、揭晓答案、删除房间
- **职责**：管理游戏流程，维护房间秩序
- **特征**：具有OpenAI API资源，熟悉游戏规则

### 2.2 玩家 (Player) 
- **权限**：加入房间、参与AI对话、群聊交流
- **职责**：通过提问推理故事答案
- **特征**：对推理游戏感兴趣，具有逻辑思维能力

### 2.3 管理员 (Admin)
- **权限**：审核故事、管理房间、配置系统、发布公告
- **职责**：维护平台内容质量，管理系统运营
- **特征**：平台运营人员

### 2.4 故事贡献者 (Story Contributor)
- **权限**：上传故事到广场、在线编辑提交故事
- **职责**：为平台贡献优质故事内容
- **特征**：具有创作能力，了解海龟汤故事格式

## 3. 核心功能模块

### 3.1 房间管理系统
#### 3.1.1 房间创建
- **功能描述**：用户可创建游戏房间，配置AI参数
- **输入要素**：昵称、API配置（代理地址、密钥、模型）
- **输出结果**：生成6位邀请码，创建房间成功
- **业务规则**：
  - 邀请码唯一性检验
  - API配置有效性验证
  - 房间创建者自动成为房主

#### 3.1.2 房间加入
- **功能描述**：通过邀请码加入已存在的房间
- **输入要素**：昵称、邀请码
- **输出结果**：成功加入房间，获取房间基本信息
- **业务规则**：
  - 昵称在房间内唯一性检验
  - 邀请码有效性验证
  - 自动加入在线用户列表

#### 3.1.3 房间销毁
- **功能描述**：房主可删除房间，管理员可强制删除
- **权限控制**：仅房主和管理员可执行
- **清理机制**：每日凌晨3点自动清空所有房间

### 3.2 AI对话系统
#### 3.2.1 智能问答
- **功能描述**：基于OpenAI API的AI主持人问答
- **输入处理**：用户问题 + 故事上下文 + 游戏规则
- **输出格式**：标准海龟汤回答("是"/"不是"/"不重要")
- **特殊功能**：
  - 故事还原检测（识别"开始故事还原："前缀）
  - 线索整理（识别"整理线索"指令）
  - 异步处理机制，避免阻塞

#### 3.2.2 游戏规则引擎
- **核心规则**：
  - 只能回答"是"、"不是"、"不重要"
  - 故事还原阶段限制回答格式
  - 线索整理功能
- **胜利检测**：AI判断故事还原正确性
- **预设机制**：支持自定义AI人格和规则

### 3.3 双聊天系统
#### 3.3.1 AI游戏聊天
- **功能描述**：与AI主持人的问答交互
- **消息流程**：用户问题 → AI异步处理 → 回答返回
- **特殊标识**：系统消息、AI回答、用户问题分类显示

#### 3.3.2 无AI群聊
- **功能描述**：玩家间自由交流讨论
- **实现方式**：独立消息通道，不涉及AI处理
- **增强功能**：支持@用户名高亮显示

### 3.4 故事管理系统
#### 3.4.1 故事上传
- **支持格式**：JSON文件（单个或批量）
- **文件限制**：最大20MB
- **数据结构**：
  ```json
  {
    "surface": "故事问题",
    "answer": "完整答案", 
    "victory_condition": "获胜条件",
    "additional": "补充说明"
  }
  ```

#### 3.4.2 故事切换
- **权限控制**：仅房主可操作
- **切换效果**：重置游戏状态，清除揭晓标志
- **系统通知**：向所有玩家发送切换通知

#### 3.4.3 答案揭晓
- **触发条件**：房主主动揭晓或AI判断胜利
- **揭晓效果**：显示完整故事答案
- **状态持久**：揭晓后状态保持，不可撤销

### 3.5 故事广场系统
#### 3.5.1 故事展示
- **展示内容**：故事名称、编号、汤面预览
- **排序方式**：按编号排序
- **一键开始**：直接加载故事到房间

#### 3.5.2 故事上传
- **上传方式一**：文件上传（JSON格式）
- **上传方式二**：在线编辑表单
- **审核流程**：上传 → 待审核 → 管理员审核 → 发布/拒绝
- **编号系统**：自动递增编号（#00001格式）

#### 3.5.3 编号检索
- **功能描述**：通过故事编号快速加载故事
- **输入格式**：#编号（如#00001）
- **匹配机制**：精确匹配故事编号

### 3.6 实时通信系统
#### 3.6.1 在线状态
- **心跳机制**：定期发送心跳包保持在线状态
- **超时检测**：1分钟无心跳自动下线
- **在线展示**：实时显示房间在线用户列表

#### 3.6.2 消息轮询
- **轮询频率**：定期轮询获取新消息
- **消息类型**：AI对话消息、群聊消息、系统通知
- **实时性**：准实时消息推送体验

### 3.7 管理员系统
#### 3.7.1 故事审核
- **待审核列表**：显示所有待审核故事
- **审核操作**：通过/拒绝/删除
- **状态流转**：待审核 → 已发布/已拒绝

#### 3.7.2 房间管理
- **房间监控**：查看所有在线房间信息
- **强制管理**：删除违规房间
- **用户管理**：查看房间成员列表

#### 3.7.3 系统配置
- **选项管理**：配置模型列表、API地址、密钥选项
- **公告系统**：发布平台公告和通知
- **参数调节**：调整系统运行参数

## 4. 用户旅程

### 4.1 新用户首次体验
1. **进入平台** → 查看首页介绍
2. **了解游戏** → 访问故事广场浏览
3. **快速体验** → 点击"一键开始"加入游戏
4. **深度参与** → 创建房间自主游戏

### 4.2 房主用户流程
1. **准备阶段** → 配置OpenAI API参数
2. **创建房间** → 设置房间参数，获取邀请码
3. **准备故事** → 上传故事文件或从广场加载
4. **邀请玩家** → 分享邀请码给其他玩家
5. **主持游戏** → 监控游戏进度，适时揭晓答案
6. **结束游戏** → 切换新故事或删除房间

### 4.3 玩家用户流程
1. **加入房间** → 输入昵称和邀请码
2. **了解题目** → 查看当前故事汤面
3. **开始推理** → 向AI提问获取线索
4. **协作讨论** → 在群聊中与其他玩家交流
5. **整理线索** → 使用"整理线索"功能梳理信息
6. **尝试还原** → 提交完整故事推理

### 4.4 故事贡献者流程
1. **创作故事** → 设计有趣的海龟汤题目
2. **提交审核** → 通过在线编辑或文件上传
3. **等待审核** → 管理员审核故事质量
4. **发布分享** → 审核通过后在广场展示

## 5. 技术需求

### 5.1 性能要求
- **并发支持**：支持多房间并发游戏
- **响应时间**：AI回复响应时间 < 30秒
- **消息延迟**：消息传递延迟 < 2秒
- **文件处理**：支持最大20MB文件上传

### 5.2 可靠性要求  
- **数据安全**：API密钥等敏感信息加密存储
- **故障恢复**：异常情况下的优雅降级
- **数据一致性**：并发场景下的数据完整性
- **定时清理**：定期清理过期房间和数据

### 5.3 扩展性要求
- **AI模型**：支持多种OpenAI模型切换
- **API代理**：支持多个API代理地址配置
- **故事格式**：灵活的故事数据结构
- **插件机制**：支持功能插件扩展

## 6. 数据模型

### 6.1 房间数据结构
```json
{
  "owner": "房主昵称",
  "base_url": "OpenAI API地址", 
  "api_key": "API密钥",
  "model": "AI模型名称",
  "messages": [], // 游戏对话历史
  "members": {}, // 房间成员信息
  "stories": [], // 已上传故事列表
  "current_story": 0, // 当前故事索引
  "chat_messages": [], // 群聊消息
  "online_users": {}, // 在线用户心跳
  "reveal_answer_flag": false, // 答案揭晓标志
  "passed": false // 游戏通关标志
}
```

### 6.2 故事数据结构
```json
{
  "surface": "故事题目/汤面",
  "answer": "完整故事答案/汤底",
  "victory_condition": "获胜条件描述",
  "additional": "补充说明信息"
}
```

### 6.3 广场故事结构
```json
{
  "name": "故事名称",
  "id": "故事编号(#00001)",
  "surface": "故事汤面",
  "data": {} // 完整故事数据
}
```

## 7. 非功能性需求

### 7.1 安全需求
- API密钥安全存储，不在客户端暴露
- 用户输入内容过滤，防止恶意内容
- 管理员权限验证，防止越权操作
- 文件上传安全检查，防止恶意文件

### 7.2 可用性需求
- 界面简洁直观，符合用户使用习惯
- 错误信息友好，提供明确的操作指引
- 移动端适配，支持响应式设计
- 操作反馈及时，提供加载状态提示

### 7.3 兼容性需求
- 支持主流浏览器（Chrome、Safari、Firefox）
- 支持移动设备访问
- API接口RESTful设计，便于移动端对接
- 数据格式标准化，便于系统集成

## 8. 约束条件

### 8.1 技术约束
- 依赖OpenAI API服务可用性
- 需要稳定的网络连接
- Python Flask框架限制
- 内存存储方案，重启后数据丢失

### 8.2 业务约束  
- 故事内容需符合平台规范
- API使用成本由用户承担
- 房间数量受服务器性能限制
- 单文件上传大小限制20MB

### 8.3 运营约束
- 需要管理员人工审核故事
- 定期清理过期数据和房间
- 监控API使用量和成本
- 处理用户举报和违规内容

## 9. 未来规划

### 9.1 功能增强
- 用户账号体系和个人中心
- 游戏数据统计和排行榜
- 更丰富的AI人格和主题
- 语音交互和多媒体支持

### 9.2 平台扩展
- 移动端原生应用
- 微信小程序版本
- API开放平台
- 第三方集成支持

### 9.3 商业化
- 会员订阅服务
- 高级AI模型支持
- 企业定制版本
- 内容付费和创作者分成

---

**文档版本**：v1.0  
**创建日期**：2025-09-15  
**更新日期**：2025-09-15  
**负责人**：产品团队